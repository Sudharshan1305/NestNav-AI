<%- include('partials/header') %>
    <%- include('partials/navbar') %>

        <div class="container mt-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 fw-bold text-primary">
                            <i class="fas fa-chart-line me-2"></i>Neighborhood Forecast
                        </h1>
                        <p class="text-muted mb-0">
                            Get detailed predictions and trends for Chennai neighborhoods.
                        </p>
                    </div>
                    <div>
                        <a href="/dashboard" class="btn btn-outline-primary">
                            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Error Messages -->
            <% if (typeof query !=='undefined' && query.error) { %>
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <% if (query.error==='missing_fields' ) { %>
                                Please fill in all required fields.
                                <% } else { %>
                                    An error occurred. Please try again.
                                    <% } %>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    </div>
                </div>
                <% } %>

                    <!-- Forecast Controls -->
                    <div class="row">
                        <div class="col-lg-6 d-flex">
                            <div class="card shadow-sm mb-4 w-100 h-100">
                                <div class="card-header bg-primary text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-sliders-h me-2"></i>Forecast Settings
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <form id="forecastForm" method="POST" action="/forecast">
                                        <!-- Area Selection -->
                                        <div class="mb-4">
                                            <label for="forecastArea" class="form-label fw-bold">
                                                <i class="fas fa-map-marker-alt text-primary me-2"></i>Select Area
                                            </label>
                                            <select class="form-select form-select-lg" id="forecastArea"
                                                name="forecastArea" required>
                                                <option value="">Choose your area...</option>
                                                <% areas.forEach(area=> { %>
                                                    <option value="<%= area %>">
                                                        <%= area %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                        </div>

                                        <!-- Forecast Range -->
                                        <div class="mb-4">
                                            <label for="forecastRange" class="form-label fw-bold">
                                                <i class="fas fa-calendar-alt text-info me-2"></i>Forecast Range
                                            </label>
                                            <select class="form-select" id="forecastRange" name="forecastRange" required>
                                                <option value="1">1 Month</option>
                                                <option value="3">3 Months</option>
                                                <option value="6">6 Months</option>
                                                <option value="12" selected>12 Months</option>
                                                <option value="24">24 Months</option>
                                                <option value="36">36 Months</option>
                                            </select>
                                        </div>

                                        <!-- Submit Button -->
                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg" id="forecastBtn">
                                                <i class="fas fa-chart-line me-2"></i>Generate Forecast
                                                <span class="spinner-border spinner-border-sm ms-2 d-none"
                                                    id="forecastSpinner"></span>
                                            </button>
                                        </div>
                                    </form>
                                    <hr>
                                    <div>
                                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>About these forecasts</h6>
                                        <p class="mb-2 small text-muted">NestNav uses historical monthly prices from your selected area and projects them forward. Seasonality and trend are captured automatically. Results are for guidance and should be validated with on-ground checks.</p>
                                        <ul class="small text-muted mb-0">
                                            <li class="mb-1"><strong>Confidence band:</strong> Shaded region shows plausible range around the price line.</li>
                                            <li class="mb-1"><strong>Horizon:</strong> Longer horizons (24–36 months) have higher uncertainty.</li>
                                            <li class="mb-0"><strong>Cross-verify:</strong> Use Plots and Rentals forecasts to gauge supply-side pressure.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tips Card -->
                        <div class="col-lg-6 d-flex">
                            <div class="card shadow-sm mb-4 w-100 h-100">
                                <div class="card-header bg-info text-white">
                                    <h4 class="mb-0">
                                        <i class="fas fa-lightbulb me-2"></i>Forecast Tips
                                    </h4>
                                </div>
                                <div class="card-body p-4">
                                    <ul class="list-unstyled mb-0">
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Pick a well-known area:</strong> You’ll interpret the trends better if you know local events and seasonality.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Match horizon to your decision:</strong> 1–3 months for short-term rent, 12–36 months for investment planning.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Compare multiple zones:</strong> Run forecasts for 2–3 nearby zones to understand relative movement.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Watch the band:</strong> Wider confidence bands mean higher uncertainty—treat those forecasts cautiously.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Use budget along with price:</strong> Cross-check predicted price against your budget to filter impractical areas.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Check plots and rentals:</strong> Low plots or rentals could signal supply constraints and faster price moves.</li>
                                        <li class="mb-2"><i class="fas fa-check-circle text-success me-2"></i><strong>Re-run monthly:</strong> Refresh the model as new data comes in to keep plans current.</li>
                                        <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i><strong>Look for consistency:</strong> A steady uptrend with narrow bands is typically more reliable than erratic swings.</li>
                                    </ul>
                                    <hr>
                                    <small class="text-muted">Tip: Use the Results page mini-forecasts to validate price with on-ground availability of plots and rentals for the same area.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Forecast Charts -->
                    <div class="row mt-4" id="forecastChartsSection"></div>
        </div>

        <!-- Chart.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
        <script src="/js/dataVisualization.js"></script>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('forecastForm');
                const forecastBtn = document.getElementById('forecastBtn');
                const forecastSpinner = document.getElementById('forecastSpinner');
                
                const chartContainer = document.getElementById('forecastChartsSection');
                let chartPrice, chartDemand;

                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const area = document.getElementById('forecastArea').value;
                    if (!area) {
                        alert('Please select an area first!');
                        return;
                    }

                    forecastBtn.disabled = true;
                    forecastSpinner.classList.remove('d-none');
                    chartContainer.innerHTML = '';

                    try {
                        // Call Flask forecast API through Node route
                        const months = parseInt(document.getElementById('forecastRange').value, 10) || 12;
                        const response = await fetch('/dashboard/api/forecast', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ area, months })
                        });

                        const data = await response.json();

                        if (!response.ok) throw new Error(data.error || 'Error fetching forecast');

                        const labels = data.map(item => item.ds);
                        const prices = data.map(item => item.yhat);

                        // Render charts
                        forecastBtn.disabled = false;
                        forecastSpinner.classList.add('d-none');
                        forecastBtn.innerHTML = '<i class="fas fa-chart-line me-2"></i>Generate Forecast';

                        chartContainer.innerHTML = `
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Price Forecast</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastPriceChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Predicted Demand (AI Estimated)</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastDemandChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-cubes me-2"></i>Available Plots Forecast</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastPlotsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-home me-2"></i>Rental Availability Forecast</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="forecastRentalsChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;

                        const ctxPrice = document.getElementById('forecastPriceChart');
                        const ctxDemand = document.getElementById('forecastDemandChart');
                        const ctxPlots = document.getElementById('forecastPlotsChart');
                        const ctxRentals = document.getElementById('forecastRentalsChart');

                        if (chartPrice) chartPrice.destroy();
                        if (chartDemand) chartDemand.destroy();

                        chartPrice = new Chart(ctxPrice, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Predicted Average Price (₹)`,
                                    data: prices,
                                    borderColor: '#007bff',
                                    backgroundColor: '#007bff33',
                                    fill: true,
                                    tension: 0.3
                                },
                                {
                                    label: 'Lower Confidence',
                                    data: data.map(d => d.yhat_lower),
                                    borderColor: 'transparent',
                                    backgroundColor: '#007bff15',
                                    fill: '+1',
                                    pointRadius: 0
                                },
                                {
                                    label: 'Upper Confidence',
                                    data: data.map(d => d.yhat_upper),
                                    borderColor: 'transparent',
                                    backgroundColor: '#007bff15',
                                    fill: false,
                                    pointRadius: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: { display: true },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    y: { 
                                        title: { display: true, text: 'Average Price (₹)' },
                                        ticks: { callback: (val) => '₹' + val.toLocaleString() }
                                    },
                                    x: { title: { display: true, text: 'Month' } }
                                }
                            }
                        });

                        // Simulate demand forecast (for visual effect only)
                        const demand = prices.map(p => Math.round(p / 1000 + Math.random() * 20));

                        chartDemand = new Chart(ctxDemand, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Demand Index',
                                    data: demand,
                                    backgroundColor: '#17a2b8'
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: { title: { display: true, text: 'Demand Index' } },
                                    x: { title: { display: true, text: 'Month' } }
                                }
                            }
                        });

                        // Fetch and render Available Plots Forecast
                        try {
                            const plotsResp = await fetch('/api/forecast-plots', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ area, months })
                            });
                            const plotsJson = await plotsResp.json();
                            if (plotsResp.ok && plotsJson.success) {
                                const pLabels = plotsJson.forecast.map(d => d.ds);
                                const pValues = plotsJson.forecast.map(d => d.yhat);
                                new Chart(ctxPlots, {
                                    type: 'line',
                                    data: { labels: pLabels, datasets: [{ label: 'Estimated Available Plots', data: pValues, borderColor: '#8b5cf6', backgroundColor: '#8b5cf622', fill: true, tension: 0.3 }] },
                                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Plots' } }, x: { title: { display: true, text: 'Month' } } } }
                                });
                            }
                        } catch(_) {}

                        // Fetch and render Rental Availability Forecast
                        try {
                            const rentResp = await fetch('/api/forecast-rentals', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ area, months })
                            });
                            const rentJson = await rentResp.json();
                            if (rentResp.ok && rentJson.success) {
                                const rLabels = rentJson.forecast.map(d => d.ds);
                                const rValues = rentJson.forecast.map(d => d.yhat);
                                new Chart(ctxRentals, {
                                    type: 'bar',
                                    data: { labels: rLabels, datasets: [{ label: 'Estimated Rentals Available', data: rValues, backgroundColor: '#22c55e' }] },
                                    options: { responsive: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Units' } }, x: { title: { display: true, text: 'Month' } } } }
                                });
                            }
                        } catch(_) {}

                    } catch (err) {
                        console.error(err);
                        chartContainer.innerHTML = `
                    <div class="col-12 text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to fetch forecast. Please try again later.
                    </div>`;
                        forecastBtn.disabled = false;
                        forecastSpinner.classList.add('d-none');
                    }
                });
            });
        </script>


        <%- include('partials/footer') %>